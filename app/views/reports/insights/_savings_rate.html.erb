<% return unless data.present? %>

<div class="space-y-6">
  <%# Key Metrics Card %>
  <div class="bg-container rounded-xl shadow-border-xs p-5">
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.savings_rate.current_rate") %></p>
        <% rate = data[:current_rate][:percent] %>
        <% target = data[:target][:rate] %>
        <p class="text-3xl font-bold <%= rate >= target ? 'text-success' : rate >= 0 ? 'text-warning' : 'text-destructive' %>">
          <%= number_with_precision(rate, precision: 1) %>%
        </p>
        <p class="text-xs text-subdued mt-1">
          <%= t("reports.insights.savings_rate.target_label", rate: target) %>
        </p>
      </div>

      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.savings_rate.income") %></p>
        <p class="text-2xl font-semibold text-success">
          <%= data[:current_rate][:income][:formatted] %>
        </p>
      </div>

      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.savings_rate.expenses") %></p>
        <p class="text-2xl font-semibold text-destructive">
          <%= data[:current_rate][:expenses][:formatted] %>
        </p>
      </div>

      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.savings_rate.net_savings") %></p>
        <% savings_amount = data[:current_rate][:savings][:amount] %>
        <p class="text-2xl font-semibold <%= savings_amount >= 0 ? 'text-success' : 'text-destructive' %>">
          <%= data[:current_rate][:savings][:formatted] %>
        </p>
      </div>
    </div>
  </div>

  <%# Progress Bar Card %>
  <div class="bg-container rounded-xl shadow-border-xs p-5">
    <div class="flex items-center justify-between mb-3">
      <p class="text-sm font-medium text-primary"><%= t("reports.insights.savings_rate.progress_to_target") %></p>
      <% rate = data[:current_rate][:percent] %>
      <% target = data[:target][:rate] %>
      <span class="text-sm <%= rate >= target ? 'text-success' : rate >= 0 ? 'text-secondary' : 'text-destructive' %>">
        <%= rate >= target ? t("reports.insights.savings_rate.on_target") : rate >= 0 ? t("reports.insights.savings_rate.below_target_by", percent: (target - rate).round(1)) : t("reports.insights.savings_rate.spending_exceeds_income") %>
      </span>
    </div>

    <div class="relative h-3 bg-secondary/20 rounded-full overflow-hidden">
      <% if rate >= 0 %>
        <% width = [rate, 100].min %>
        <div class="absolute inset-y-0 left-0 <%= rate >= target ? 'bg-success' : 'bg-warning' %> rounded-full"
             style="width: <%= width %>%"></div>
        <div class="absolute inset-y-0 w-0.5 bg-primary/60" style="left: <%= target %>%"></div>
      <% else %>
        <% width = [[rate.abs, 100].min, 10].max %>
        <div class="absolute inset-y-0 right-0 bg-destructive rounded-full" style="width: <%= width %>%"></div>
      <% end %>
    </div>

    <div class="flex items-center gap-4 mt-3 text-xs text-subdued">
      <span class="flex items-center gap-1"><span class="w-2 h-2 bg-success rounded-full"></span> On target</span>
      <span class="flex items-center gap-1"><span class="w-2 h-2 bg-warning rounded-full"></span> Below target</span>
      <span class="flex items-center gap-1"><span class="w-2 h-2 bg-primary/60 rounded-full"></span> Target (<%= target %>%)</span>
    </div>
  </div>

  <%# 12-Month Trend Card %>
  <% if data[:historical_rates].present? && data[:historical_rates].length > 1 %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm font-medium text-primary mb-4"><%= t("reports.insights.savings_rate.trend_title") %></p>

      <% rates = data[:historical_rates] %>
      <% max_abs = [rates.map { |r| r[:rate].abs }.max, 20].max %>

      <div class="flex items-end gap-1 h-20">
        <% rates.each_with_index do |month, idx| %>
          <% height_pct = (month[:rate].abs / max_abs * 100).clamp(8, 100) %>
          <% bar_color = month[:rate] >= data[:target][:rate] ? 'bg-success' : month[:rate] >= 0 ? 'bg-warning' : 'bg-destructive' %>
          <% is_current = idx == rates.length - 1 %>

          <div class="flex-1 flex flex-col items-center justify-end h-full"
               title="<%= month[:month] %>: <%= month[:rate] %>%">
            <div class="w-full max-w-6 <%= bar_color %> rounded-sm <%= is_current ? 'opacity-100' : 'opacity-60' %>"
                 style="height: <%= height_pct %>%;"></div>
          </div>
        <% end %>
      </div>

      <div class="flex justify-between mt-2">
        <% rates.each_with_index do |month, idx| %>
          <% is_current = idx == rates.length - 1 %>
          <span class="flex-1 text-center text-[10px] <%= is_current ? 'text-primary font-medium' : 'text-subdued' %>">
            <%= month[:month_short] %>
          </span>
        <% end %>
      </div>

      <div class="flex items-center justify-center gap-4 mt-4 text-xs text-subdued">
        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-success rounded-sm"></span> On target</span>
        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-warning rounded-sm"></span> Below</span>
        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-destructive rounded-sm"></span> Negative</span>
      </div>
    </div>
  <% end %>

  <%# Best/Worst Months Card %>
  <% best = data[:best_month] %>
  <% worst = data[:worst_month] %>
  <% if best && worst && (best[:rate] != worst[:rate] || best[:rate] != 0) %>
    <div class="grid grid-cols-2 gap-4">
      <% if best[:rate] > 0 || best[:savings][:amount] > 0 %>
        <div class="bg-success/10 border border-success/30 rounded-xl p-4">
          <div class="flex items-center gap-2 mb-2">
            <%= icon("trophy", class: "w-4 h-4 text-success") %>
            <span class="text-sm text-secondary"><%= t("reports.insights.savings_rate.best_month") %></span>
          </div>
          <p class="font-medium text-primary"><%= best[:month] %></p>
          <p class="text-lg font-semibold text-success"><%= best[:rate] %>%</p>
        </div>
      <% end %>
      <div class="bg-destructive/10 border border-destructive/30 rounded-xl p-4">
        <div class="flex items-center gap-2 mb-2">
          <%= icon("alert-triangle", class: "w-4 h-4 text-destructive") %>
          <span class="text-sm text-secondary"><%= t("reports.insights.savings_rate.worst_month") %></span>
        </div>
        <p class="font-medium text-primary"><%= worst[:month] %></p>
        <p class="text-lg font-semibold text-destructive"><%= worst[:rate] %>%</p>
      </div>
    </div>
  <% end %>

  <%# Insights %>
  <% if data[:insights].present? %>
    <div class="space-y-2">
      <% data[:insights].each do |insight| %>
        <% colors = {
          positive: "text-success",
          warning: "text-warning",
          alert: "text-destructive"
        } %>
        <% icons = {
          positive: "check-circle",
          warning: "alert-triangle",
          alert: "alert-circle"
        } %>

        <div class="flex items-start gap-2 text-sm">
          <%= icon(icons[insight[:severity]] || "info", class: "w-4 h-4 mt-0.5 flex-shrink-0 #{colors[insight[:severity]] || 'text-secondary'}") %>
          <p class="text-primary"><%= insight[:message] %></p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
