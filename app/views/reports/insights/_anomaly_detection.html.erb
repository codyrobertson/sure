<% return unless data.present? %>

<div class="space-y-6">
  <%# Summary Stats %>
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.anomalies_found") %></p>
      <p class="text-2xl font-semibold <%= data[:summary][:anomaly_count] > 0 ? 'text-warning' : 'text-success' %>">
        <%= data[:summary][:anomaly_count] %>
      </p>
    </div>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.critical") %></p>
      <p class="text-2xl font-semibold text-destructive">
        <%= data[:summary][:alert_count] %>
      </p>
    </div>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.warnings") %></p>
      <p class="text-2xl font-semibold text-warning">
        <%= data[:summary][:warning_count] %>
      </p>
    </div>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.new_merchants") %></p>
      <p class="text-2xl font-semibold text-primary">
        <%= data[:summary][:new_merchant_count] %>
      </p>
    </div>
  </div>

  <%# Category Anomalies %>
  <% if data[:anomalies].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm font-medium text-primary mb-4">
        <%= t("reports.insights.anomaly_detection.unusual_spending") %>
      </p>

      <div class="space-y-4">
        <% data[:anomalies].each do |anomaly| %>
          <% severity_class = anomaly[:severity] == :alert ? 'border-destructive/50 bg-destructive/5' : 'border-warning/50 bg-warning/5' %>
          <% badge_class = anomaly[:severity] == :alert ? 'bg-destructive text-white' : 'bg-warning text-white' %>

          <div class="border rounded-lg p-4 <%= severity_class %>">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="w-3 h-3 rounded-full" style="background-color: <%= anomaly[:category][:color] %>;"></div>
                <span class="font-medium text-primary"><%= anomaly[:category][:name] %></span>
                <span class="text-xs px-2 py-0.5 rounded-full <%= badge_class %>">
                  +<%= anomaly[:deviation_percent] - 100 %>%
                </span>
              </div>
              <div class="text-right">
                <p class="font-semibold text-primary"><%= anomaly[:current][:formatted] %></p>
                <p class="text-xs text-tertiary">
                  <%= t("reports.insights.anomaly_detection.vs_average", amount: anomaly[:average][:formatted]) %>
                </p>
              </div>
            </div>

            <%# Visual comparison bar %>
            <div class="relative h-6 bg-container rounded-full overflow-hidden mb-3">
              <% bar_width = [100, (100.0 / anomaly[:deviation_percent]) * 100].min %>
              <div class="absolute inset-y-0 left-0 bg-secondary/30 rounded-full" style="width: <%= bar_width %>%;"></div>
              <div class="absolute inset-y-0 left-0 <%= anomaly[:severity] == :alert ? 'bg-destructive' : 'bg-warning' %> rounded-full opacity-80" style="width: 100%;"></div>
              <div class="absolute inset-0 flex items-center justify-between px-3 text-xs">
                <span class="text-white font-medium"><%= t("reports.insights.anomaly_detection.current_label") %></span>
                <span class="text-white/80"><%= t("reports.insights.anomaly_detection.average_label") %>: <%= anomaly[:average][:formatted] %></span>
              </div>
            </div>

            <%# Top transactions %>
            <% if anomaly[:top_transactions].any? %>
              <details class="group">
                <summary class="text-xs text-secondary cursor-pointer hover:text-primary">
                  <%= t("reports.insights.anomaly_detection.top_transactions") %>
                  <%= icon("chevron-down", class: "w-3 h-3 inline-block ml-1 transition-transform group-open:rotate-180") %>
                </summary>
                <div class="mt-2 space-y-1">
                  <% anomaly[:top_transactions].each do |tx| %>
                    <div class="flex items-center justify-between text-sm py-1 border-b border-secondary/50 last:border-0">
                      <div class="flex items-center gap-2">
                        <span class="text-primary truncate max-w-48"><%= tx[:name] %></span>
                        <% if tx[:merchant] %>
                          <span class="text-xs text-tertiary">(<%= tx[:merchant] %>)</span>
                        <% end %>
                      </div>
                      <div class="text-right">
                        <span class="font-medium text-primary"><%= tx[:amount][:formatted] %></span>
                        <span class="text-xs text-tertiary ml-2"><%= tx[:date] %></span>
                      </div>
                    </div>
                  <% end %>
                </div>
              </details>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="bg-success/10 border border-success/30 rounded-xl p-5 flex items-center gap-3">
      <%= icon("check-circle", class: "w-5 h-5 text-success") %>
      <p class="text-sm text-primary"><%= t("reports.insights.anomaly_detection.no_anomalies") %></p>
    </div>
  <% end %>

  <%# New Merchants %>
  <% if data[:new_merchants].any? %>
    <div class="bg-surface-inset rounded-xl p-5">
      <div class="flex items-center gap-2 mb-4">
        <%= icon("store", class: "w-5 h-5 text-primary") %>
        <h4 class="text-sm font-medium text-secondary">
          <%= t("reports.insights.anomaly_detection.new_merchants_title") %>
        </h4>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <% data[:new_merchants].each do |merchant| %>
          <div class="flex items-center justify-between p-3 bg-container rounded-lg">
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 bg-primary/10 text-primary rounded font-medium">
                <%= t("reports.insights.anomaly_detection.new_badge") %>
              </span>
              <span class="text-sm font-medium text-primary truncate max-w-40">
                <%= merchant[:merchant][:name] %>
              </span>
            </div>
            <div class="text-right">
              <p class="text-sm font-medium text-primary"><%= merchant[:total_spent][:formatted] %></p>
              <p class="text-xs text-tertiary">
                <%= t("reports.insights.anomaly_detection.transaction_count", count: merchant[:transaction_count]) %>
              </p>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
