<% return unless data.present? %>

<div class="space-y-8">
  <%# Summary Stats - Simple inline %>
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
    <div>
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.anomalies_found") %></p>
      <p class="text-2xl font-semibold <%= data[:summary][:anomaly_count] > 0 ? 'text-warning' : 'text-success' %>">
        <%= data[:summary][:anomaly_count] %>
      </p>
    </div>
    <div>
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.critical") %></p>
      <p class="text-2xl font-semibold text-destructive">
        <%= data[:summary][:alert_count] %>
      </p>
    </div>
    <div>
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.warnings") %></p>
      <p class="text-2xl font-semibold text-warning">
        <%= data[:summary][:warning_count] %>
      </p>
    </div>
    <div>
      <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.new_merchants") %></p>
      <p class="text-2xl font-semibold text-primary">
        <%= data[:summary][:new_merchant_count] %>
      </p>
    </div>
  </div>

  <%# Category Anomalies %>
  <% if data[:anomalies].any? %>
    <div>
      <p class="text-sm text-secondary mb-4">
        <%= t("reports.insights.anomaly_detection.unusual_spending") %>
      </p>

      <div class="space-y-4">
        <% data[:anomalies].each do |anomaly| %>
          <% is_alert = anomaly[:severity] == :alert %>

          <div class="py-4 border-l-2 pl-4 <%= is_alert ? 'border-destructive' : 'border-warning' %>">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background-color: <%= anomaly[:category][:color] %>;"></div>
                <span class="font-medium text-primary"><%= anomaly[:category][:name] %></span>
                <span class="text-xs px-2 py-0.5 rounded-full <%= is_alert ? 'bg-destructive/20 text-destructive' : 'bg-warning/20 text-warning' %>">
                  +<%= anomaly[:deviation_percent] - 100 %>%
                </span>
              </div>
              <div class="text-right">
                <p class="font-semibold text-primary"><%= anomaly[:current][:formatted] %></p>
                <p class="text-xs text-tertiary">
                  <%= t("reports.insights.anomaly_detection.vs_average", amount: anomaly[:average][:formatted]) %>
                </p>
              </div>
            </div>

            <%# Visual comparison bar %>
            <div class="relative h-2 bg-secondary/20 rounded-full overflow-hidden mb-2">
              <% bar_width = [100, (100.0 / anomaly[:deviation_percent]) * 100].min %>
              <div class="absolute inset-y-0 left-0 bg-secondary/40 rounded-full" style="width: <%= bar_width %>%;"></div>
              <div class="absolute inset-y-0 left-0 <%= is_alert ? 'bg-destructive' : 'bg-warning' %> rounded-full opacity-80" style="width: 100%;"></div>
            </div>

            <%# Top transactions %>
            <% if anomaly[:top_transactions].any? %>
              <details class="text-sm">
                <summary class="text-xs text-secondary cursor-pointer hover:text-primary">
                  <%= t("reports.insights.anomaly_detection.top_transactions") %>
                </summary>
                <div class="mt-2 space-y-1 pl-2 border-l border-secondary/20">
                  <% anomaly[:top_transactions].each do |tx| %>
                    <div class="flex items-center justify-between py-1 text-sm">
                      <span class="text-primary truncate"><%= tx[:name] %></span>
                      <span class="font-medium text-primary ml-2"><%= tx[:amount][:formatted] %></span>
                    </div>
                  <% end %>
                </div>
              </details>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="flex items-center gap-2 text-sm text-success">
      <%= icon("check-circle", class: "w-4 h-4") %>
      <p><%= t("reports.insights.anomaly_detection.no_anomalies") %></p>
    </div>
  <% end %>

  <%# New Merchants %>
  <% if data[:new_merchants].any? %>
    <div>
      <p class="text-sm text-secondary mb-3">
        <%= t("reports.insights.anomaly_detection.new_merchants_title") %>
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <% data[:new_merchants].each do |merchant| %>
          <div class="flex items-center justify-between py-2">
            <div class="flex items-center gap-2">
              <span class="text-xs px-1.5 py-0.5 bg-primary/10 text-primary rounded font-medium">
                <%= t("reports.insights.anomaly_detection.new_badge") %>
              </span>
              <span class="text-sm font-medium text-primary">
                <%= merchant[:merchant][:name] %>
              </span>
            </div>
            <div class="text-right text-sm">
              <span class="font-medium text-primary"><%= merchant[:total_spent][:formatted] %></span>
              <span class="text-tertiary ml-1">
                (<%= t("reports.insights.anomaly_detection.transaction_count", count: merchant[:transaction_count]) %>)
              </span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
