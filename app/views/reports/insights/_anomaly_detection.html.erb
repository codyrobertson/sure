<% return unless data.present? %>

<div class="space-y-6">
  <%# Summary Stats Card %>
  <div class="bg-container rounded-xl shadow-border-xs p-5">
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6">
      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.anomalies_found") %></p>
        <p class="text-2xl font-semibold <%= data[:summary][:anomaly_count] > 0 ? 'text-warning' : 'text-success' %>">
          <%= data[:summary][:anomaly_count] %>
        </p>
      </div>
      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.critical") %></p>
        <p class="text-2xl font-semibold text-destructive">
          <%= data[:summary][:alert_count] %>
        </p>
      </div>
      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.warnings") %></p>
        <p class="text-2xl font-semibold text-warning">
          <%= data[:summary][:warning_count] %>
        </p>
      </div>
      <div>
        <p class="text-sm text-secondary mb-1"><%= t("reports.insights.anomaly_detection.new_merchants") %></p>
        <p class="text-2xl font-semibold text-primary">
          <%= data[:summary][:new_merchant_count] %>
        </p>
      </div>
    </div>
  </div>

  <%# Category Anomalies Card %>
  <% if data[:anomalies].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm font-medium text-primary mb-4">
        <%= t("reports.insights.anomaly_detection.unusual_spending") %>
      </p>

      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-secondary/30">
              <th class="text-left py-2 text-xs text-subdued font-medium"><%= t("reports.insights.anomaly_detection.category") %></th>
              <th class="text-right py-2 text-xs text-subdued font-medium"><%= t("reports.insights.anomaly_detection.current_label") %></th>
              <th class="text-right py-2 text-xs text-subdued font-medium"><%= t("reports.insights.anomaly_detection.average_label") %></th>
              <th class="text-right py-2 text-xs text-subdued font-medium"><%= t("reports.insights.anomaly_detection.variance") %></th>
            </tr>
          </thead>
          <tbody>
            <% data[:anomalies].each do |anomaly| %>
              <% is_alert = anomaly[:severity] == :alert %>
              <tr class="border-b border-secondary/20 last:border-0">
                <td class="py-3">
                  <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full" style="background-color: <%= anomaly[:category][:color] %>;"></div>
                    <span class="font-medium text-primary"><%= anomaly[:category][:name] %></span>
                  </div>
                </td>
                <td class="py-3 text-right font-semibold text-primary"><%= anomaly[:current][:formatted] %></td>
                <td class="py-3 text-right text-subdued"><%= anomaly[:average][:formatted] %></td>
                <td class="py-3 text-right">
                  <span class="px-2 py-0.5 rounded-full text-xs font-medium <%= is_alert ? 'bg-destructive/20 text-destructive' : 'bg-warning/20 text-warning' %>">
                    +<%= anomaly[:deviation_percent] - 100 %>%
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% else %>
    <div class="bg-success/10 border border-success/30 rounded-xl p-5">
      <div class="flex items-center gap-2">
        <%= icon("check-circle", class: "w-5 h-5 text-success") %>
        <p class="text-sm text-primary"><%= t("reports.insights.anomaly_detection.no_anomalies") %></p>
      </div>
    </div>
  <% end %>

  <%# New Merchants Card %>
  <% if data[:new_merchants].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <p class="text-sm font-medium text-primary mb-4">
        <%= t("reports.insights.anomaly_detection.new_merchants_title") %>
      </p>

      <table class="w-full text-sm">
        <tbody>
          <% data[:new_merchants].each do |merchant| %>
            <tr class="border-b border-secondary/20 last:border-0">
              <td class="py-2.5">
                <div class="flex items-center gap-2">
                  <span class="text-xs px-1.5 py-0.5 bg-primary/10 text-primary rounded font-medium">
                    <%= t("reports.insights.anomaly_detection.new_badge") %>
                  </span>
                  <span class="font-medium text-primary"><%= merchant[:merchant][:name] %></span>
                </div>
              </td>
              <td class="py-2.5 text-right text-subdued">
                <%= t("reports.insights.anomaly_detection.transaction_count", count: merchant[:transaction_count]) %>
              </td>
              <td class="py-2.5 text-right font-medium text-primary w-28"><%= merchant[:total_spent][:formatted] %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>
