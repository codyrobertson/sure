<% return unless data.present? %>

<div class="space-y-6">
  <%# Alerts %>
  <% if data[:alerts].any? %>
    <div class="space-y-2">
      <% data[:alerts].each do |alert| %>
        <% bg_class = case alert[:severity]
          when :alert then "bg-destructive/10 border-destructive/30"
          when :warning then "bg-warning/10 border-warning/30"
          else "bg-surface-inset border-secondary"
        end %>
        <% icon_class = case alert[:severity]
          when :alert then "text-destructive"
          when :warning then "text-warning"
          else "text-secondary"
        end %>
        <% icon_name = case alert[:severity]
          when :alert then "alert-circle"
          when :warning then "alert-triangle"
          else "info"
        end %>

        <div class="flex items-start gap-3 p-3 rounded-lg border <%= bg_class %>">
          <%= icon(icon_name, class: "w-5 h-5 mt-0.5 #{icon_class}") %>
          <p class="text-sm text-primary"><%= alert[:message] %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Income Timing %>
  <% if data[:income_timing] %>
    <div class="bg-success/10 border border-success/30 rounded-xl p-5">
      <div class="flex items-center gap-2 mb-3">
        <%= icon("calendar-check", class: "w-5 h-5 text-success") %>
        <h4 class="text-sm font-medium text-success">
          <%= t("reports.insights.cash_flow_timing.next_income") %>
        </h4>
      </div>

      <div class="grid grid-cols-3 gap-4">
        <div>
          <p class="text-2xl font-semibold text-success"><%= data[:income_timing][:amount][:formatted] %></p>
          <p class="text-xs text-secondary"><%= t("reports.insights.cash_flow_timing.expected_amount") %></p>
        </div>
        <div>
          <p class="text-2xl font-semibold text-primary"><%= data[:income_timing][:days_until] %></p>
          <p class="text-xs text-secondary"><%= t("reports.insights.cash_flow_timing.days_away") %></p>
        </div>
        <div>
          <p class="text-2xl font-semibold text-primary"><%= Date.parse(data[:income_timing][:next_paycheck_date]).strftime("%b %d") %></p>
          <p class="text-xs text-secondary"><%= data[:income_timing][:frequency].to_s.humanize %></p>
        </div>
      </div>
    </div>
  <% end %>

  <%# Balance Projection Chart %>
  <% if data[:balance_projection].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <h4 class="text-sm font-medium text-secondary mb-4">
        <%= t("reports.insights.cash_flow_timing.balance_projection") %>
      </h4>

      <%# Mini chart %>
      <div class="relative h-24 flex items-end gap-0.5">
        <% projections = data[:balance_projection].first(14) %>
        <% max_balance = projections.map { |p| p[:projected_balance][:amount] }.max %>
        <% min_balance = projections.map { |p| p[:projected_balance][:amount] }.min %>
        <% range = max_balance - min_balance %>
        <% range = 1 if range.zero? %>

        <% projections.each do |day| %>
          <% height_percent = ((day[:projected_balance][:amount] - min_balance) / range * 80 + 20).round %>
          <% bar_color = day[:is_low] ? 'bg-destructive' : 'bg-primary' %>
          <% has_activity = day[:inflows][:amount] > 0 || day[:outflows][:amount] > 0 %>
          <% tooltip = "#{Date.parse(day[:date]).strftime('%b %d')}: #{day[:projected_balance][:formatted]}" %>

          <div class="flex-1 flex flex-col items-center">
            <div class="w-full <%= bar_color %> <%= has_activity ? 'opacity-100' : 'opacity-50' %> rounded-t cursor-default"
                 style="height: <%= height_percent %>%;"
                 title="<%= tooltip %>"></div>
          </div>
        <% end %>
      </div>

      <%# X-axis labels %>
      <div class="flex justify-between mt-2 text-xs text-tertiary">
        <span><%= t("reports.insights.cash_flow_timing.today") %></span>
        <span><%= t("reports.insights.cash_flow_timing.in_two_weeks") %></span>
      </div>
    </div>
  <% end %>

  <%# Upcoming Bills %>
  <% if data[:upcoming_bills].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <div class="flex items-center gap-2 mb-4">
        <%= icon("receipt", class: "w-5 h-5 text-primary") %>
        <h4 class="text-sm font-medium text-secondary">
          <%= t("reports.insights.cash_flow_timing.upcoming_bills") %>
        </h4>
      </div>

      <div class="space-y-2">
        <% data[:upcoming_bills].first(6).each do |bill| %>
          <% urgency_class = if !bill[:can_afford]
            'border-destructive bg-destructive/5'
          elsif bill[:days_until] <= 2
            'border-warning bg-warning/5'
          else
            'border-secondary'
          end %>

          <div class="flex items-center justify-between p-3 border rounded-lg <%= urgency_class %>">
            <div class="flex items-center gap-3">
              <div class="text-center min-w-12">
                <p class="text-lg font-semibold text-primary"><%= Date.parse(bill[:date]).day %></p>
                <p class="text-xs text-tertiary"><%= Date.parse(bill[:date]).strftime("%b") %></p>
              </div>
              <div>
                <p class="font-medium text-primary"><%= bill[:name] %></p>
                <% if bill[:category] %>
                  <p class="text-xs text-tertiary"><%= bill[:category] %></p>
                <% end %>
              </div>
            </div>
            <div class="text-right">
              <p class="font-medium text-primary"><%= bill[:amount][:formatted] %></p>
              <% if bill[:can_afford] %>
                <p class="text-xs text-success flex items-center gap-1 justify-end">
                  <%= icon("check", class: "w-3 h-3") %>
                  <%= t("reports.insights.cash_flow_timing.can_afford") %>
                </p>
              <% else %>
                <p class="text-xs text-destructive flex items-center gap-1 justify-end">
                  <%= icon("x", class: "w-3 h-3") %>
                  <%= t("reports.insights.cash_flow_timing.short") %>
                </p>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Weekly Summary %>
  <% if data[:daily_summary].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <h4 class="text-sm font-medium text-secondary mb-4">
        <%= t("reports.insights.cash_flow_timing.weekly_outlook") %>
      </h4>

      <div class="space-y-3">
        <% data[:daily_summary].each_with_index do |week, index| %>
          <div class="border border-secondary rounded-lg p-4">
            <div class="flex items-center justify-between mb-2">
              <span class="font-medium text-primary">
                <% if index == 0 %>
                  <%= t("reports.insights.cash_flow_timing.this_week") %>
                <% else %>
                  <%= t("reports.insights.cash_flow_timing.next_week") %>
                <% end %>
              </span>
              <span class="text-sm text-tertiary">
                <%= Date.parse(week[:start_date]).strftime("%b %d") %> - <%= Date.parse(week[:end_date]).strftime("%b %d") %>
              </span>
            </div>

            <div class="grid grid-cols-3 gap-4 text-sm">
              <div>
                <p class="text-tertiary"><%= t("reports.insights.cash_flow_timing.inflows") %></p>
                <p class="font-medium text-success">+<%= week[:total_inflows][:formatted] %></p>
              </div>
              <div>
                <p class="text-tertiary"><%= t("reports.insights.cash_flow_timing.outflows") %></p>
                <p class="font-medium text-destructive">-<%= week[:total_outflows][:formatted] %></p>
              </div>
              <div>
                <p class="text-tertiary"><%= t("reports.insights.cash_flow_timing.net") %></p>
                <% net = week[:net][:amount] %>
                <p class="font-medium <%= net >= 0 ? 'text-success' : 'text-destructive' %>">
                  <%= week[:net][:formatted] %>
                </p>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Insights %>
  <% if data[:insights].present? %>
    <div class="space-y-2">
      <% data[:insights].each do |insight| %>
        <% bg_class = case insight[:severity]
          when :positive then "bg-success/10 border-success/30"
          when :warning then "bg-warning/10 border-warning/30"
          when :alert then "bg-destructive/10 border-destructive/30"
          else "bg-surface-inset border-secondary"
        end %>
        <% icon_class = case insight[:severity]
          when :positive then "text-success"
          when :warning then "text-warning"
          when :alert then "text-destructive"
          else "text-secondary"
        end %>
        <% icon_name = case insight[:severity]
          when :positive then "check-circle"
          when :warning then "alert-triangle"
          when :alert then "alert-circle"
          else "info"
        end %>

        <div class="flex items-start gap-3 p-3 rounded-lg border <%= bg_class %>">
          <%= icon(icon_name, class: "w-5 h-5 mt-0.5 #{icon_class}") %>
          <p class="text-sm text-primary"><%= insight[:message] %></p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
