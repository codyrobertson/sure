<% return unless data.present? %>

<div class="space-y-6">
  <%# Alerts Card %>
  <% if data[:alerts].any? %>
    <div class="space-y-2">
      <% data[:alerts].each do |alert| %>
        <% bg_class = case alert[:severity]
          when :alert then "bg-destructive/10 border-destructive/30"
          when :warning then "bg-warning/10 border-warning/30"
          else "bg-surface-inset border-secondary"
        end %>
        <% icon_class = case alert[:severity]
          when :alert then "text-destructive"
          when :warning then "text-warning"
          else "text-secondary"
        end %>
        <% icon_name = case alert[:severity]
          when :alert then "alert-circle"
          when :warning then "alert-triangle"
          else "info"
        end %>

        <div class="flex items-start gap-3 p-4 rounded-xl border <%= bg_class %>">
          <%= icon(icon_name, class: "w-5 h-5 mt-0.5 #{icon_class}") %>
          <p class="text-sm text-primary"><%= alert[:message] %></p>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Income Timing Card %>
  <% if data[:income_timing] %>
    <div class="bg-success/10 border border-success/30 rounded-xl p-5">
      <div class="flex items-center gap-2 mb-4">
        <%= icon("calendar-check", class: "w-5 h-5 text-success") %>
        <h4 class="text-sm font-medium text-success">
          <%= t("reports.insights.cash_flow_timing.next_income") %>
        </h4>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <p class="text-2xl font-semibold text-success"><%= data[:income_timing][:amount][:formatted] %></p>
          <p class="text-xs text-secondary"><%= t("reports.insights.cash_flow_timing.expected_amount") %></p>
        </div>
        <div>
          <p class="text-2xl font-semibold text-primary"><%= data[:income_timing][:days_until] %></p>
          <p class="text-xs text-secondary"><%= t("reports.insights.cash_flow_timing.days_away") %></p>
        </div>
        <div>
          <p class="text-2xl font-semibold text-primary"><%= Date.parse(data[:income_timing][:next_paycheck_date]).strftime("%b %d") %></p>
          <p class="text-xs text-secondary"><%= data[:income_timing][:frequency].to_s.humanize %></p>
        </div>
      </div>
    </div>
  <% end %>

  <%# Balance Projection Chart Card %>
  <% if data[:balance_projection].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <h4 class="text-sm font-medium text-primary mb-4">
        <%= t("reports.insights.cash_flow_timing.balance_projection") %>
      </h4>

      <div class="relative h-24 flex items-end gap-0.5">
        <% projections = data[:balance_projection].first(14) %>
        <% max_balance = projections.map { |p| p[:projected_balance][:amount] }.max %>
        <% min_balance = projections.map { |p| p[:projected_balance][:amount] }.min %>
        <% range = max_balance - min_balance %>
        <% range = 1 if range.zero? %>

        <% projections.each_with_index do |day, idx| %>
          <% height_percent = ((day[:projected_balance][:amount] - min_balance) / range * 80 + 20).round %>
          <% bar_color = day[:is_low] ? 'bg-destructive' : 'bg-primary' %>
          <% has_activity = day[:inflows][:amount] > 0 || day[:outflows][:amount] > 0 %>
          <% is_current = idx == 0 %>

          <div class="flex-1 flex flex-col items-center justify-end h-full"
               title="<%= Date.parse(day[:date]).strftime('%b %d') %>: <%= day[:projected_balance][:formatted] %>">
            <div class="w-full <%= bar_color %> <%= is_current ? 'opacity-100' : has_activity ? 'opacity-70' : 'opacity-40' %> rounded-t"
                 style="height: <%= height_percent %>%;"></div>
          </div>
        <% end %>
      </div>

      <div class="flex justify-between mt-2 text-xs text-subdued">
        <span><%= t("reports.insights.cash_flow_timing.today") %></span>
        <span><%= t("reports.insights.cash_flow_timing.in_two_weeks") %></span>
      </div>
    </div>
  <% end %>

  <%# Upcoming Bills Card %>
  <% if data[:upcoming_bills].any? %>
    <div class="bg-container rounded-xl shadow-border-xs p-5">
      <div class="flex items-center gap-2 mb-4">
        <%= icon("receipt", class: "w-5 h-5 text-primary") %>
        <h4 class="text-sm font-medium text-primary">
          <%= t("reports.insights.cash_flow_timing.upcoming_bills") %>
        </h4>
      </div>

      <table class="w-full text-sm">
        <tbody>
          <% data[:upcoming_bills].first(6).each do |bill| %>
            <tr class="border-b border-secondary/20 last:border-0">
              <td class="py-3 w-14">
                <div class="text-center">
                  <p class="text-lg font-semibold text-primary"><%= Date.parse(bill[:date]).day %></p>
                  <p class="text-xs text-subdued"><%= Date.parse(bill[:date]).strftime("%b") %></p>
                </div>
              </td>
              <td class="py-3">
                <p class="font-medium text-primary"><%= bill[:name] %></p>
                <% if bill[:category] %>
                  <p class="text-xs text-subdued"><%= bill[:category] %></p>
                <% end %>
              </td>
              <td class="py-3 text-right">
                <p class="font-medium text-primary"><%= bill[:amount][:formatted] %></p>
                <% if bill[:can_afford] %>
                  <p class="text-xs text-success"><%= t("reports.insights.cash_flow_timing.can_afford") %></p>
                <% else %>
                  <p class="text-xs text-destructive"><%= t("reports.insights.cash_flow_timing.short") %></p>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <%# Weekly Summary Cards %>
  <% if data[:daily_summary].any? %>
    <div>
      <h4 class="text-sm font-medium text-primary mb-4">
        <%= t("reports.insights.cash_flow_timing.weekly_outlook") %>
      </h4>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <% data[:daily_summary].each_with_index do |week, index| %>
          <div class="bg-container rounded-xl shadow-border-xs p-5">
            <div class="flex items-center justify-between mb-4">
              <h5 class="font-medium text-primary">
                <% if index == 0 %>
                  <%= t("reports.insights.cash_flow_timing.this_week") %>
                <% else %>
                  <%= t("reports.insights.cash_flow_timing.next_week") %>
                <% end %>
              </h5>
              <span class="text-xs text-subdued">
                <%= Date.parse(week[:start_date]).strftime("%b %d") %> - <%= Date.parse(week[:end_date]).strftime("%b %d") %>
              </span>
            </div>

            <table class="w-full text-sm">
              <tbody>
                <tr class="border-b border-secondary/20">
                  <td class="py-2 text-secondary"><%= t("reports.insights.cash_flow_timing.inflows") %></td>
                  <td class="py-2 font-medium text-success text-right">+<%= week[:total_inflows][:formatted] %></td>
                </tr>
                <tr class="border-b border-secondary/20">
                  <td class="py-2 text-secondary"><%= t("reports.insights.cash_flow_timing.outflows") %></td>
                  <td class="py-2 font-medium text-destructive text-right">-<%= week[:total_outflows][:formatted] %></td>
                </tr>
                <tr>
                  <td class="py-2 font-medium text-primary"><%= t("reports.insights.cash_flow_timing.net") %></td>
                  <% net = week[:net][:amount] %>
                  <td class="py-2 font-medium text-right <%= net >= 0 ? 'text-success' : 'text-destructive' %>">
                    <%= week[:net][:formatted] %>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# Insights %>
  <% if data[:insights].present? %>
    <div class="space-y-2">
      <% data[:insights].each do |insight| %>
        <% colors = { positive: "text-success", warning: "text-warning", alert: "text-destructive" } %>
        <% icons = { positive: "check-circle", warning: "alert-triangle", alert: "alert-circle" } %>

        <div class="flex items-start gap-2 text-sm">
          <%= icon(icons[insight[:severity]] || "info", class: "w-4 h-4 mt-0.5 flex-shrink-0 #{colors[insight[:severity]] || 'text-secondary'}") %>
          <p class="text-primary"><%= insight[:message] %></p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
